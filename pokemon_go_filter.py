import hashlib
import sys

sys.path.append('androguard')

from androguard.core.bytecodes import apk

# Compares the permissions of the given APK with the ones
# in the official APK.
def safe_permissions(filename):

    apk_file = apk.APK(filename)
    permissions = apk_file.get_details_permissions()

    permission_file = open('permissions.txt', 'r')
    expected_permissions = set([s.strip() for s in permission_file.readlines()])

    print '\n ========== \n'

    print 'Extracting permissions of the app.'

    for permission in permissions:
        print permission


    print '\n ========== \n'

    print 'Analyzing the permissions against the official app. \n'

    dangerous_permissions = list()

    for permission in permissions:
        if permission not in expected_permissions:
            dangerous_permissions.append(permission)

    if len(dangerous_permissions) != 0:
        print '=========================='
        print 'THE APK MIGHT BE DANGEROUS!'
        print '=========================='
        print 'The following might be UNSAFE permissions requested by the app:\n'
        for permission in dangerous_permissions:
            print permission
        return False
    else:
        return True

# Compares the SHA256 of the given APK with the one of the official APK.
def safe_hash(filename):
    hash_file = open('hash.txt', 'rb')
    expected_hash = hash_file.read().strip()
    apk_file = open(filename, 'rb')
    apk_hash = hashlib.sha256(apk_file.read().strip()).hexdigest()
    
    if expected_hash != apk_hash:
        print '=========================='
        print 'THE APK MIGHT BE DANGEROUS!'
        print '=========================='
        print 'There is a hash mismatch between the official APK and the provided APK.\n'
        print 'The official hash is:', expected_hash
        print 'The hash of the provided APK is:', apk_hash
        return False
    else:
        return True
        

if len(sys.argv) != 2:
    print 'Please invoke the program as follows:'
    print 'python pokemon_go_filter.py <apk_file>'
    exit(1)

filename = sys.argv[1]

#safe_permissions(filename)
safe = safe_hash(filename)

if safe:
        print '=================='
        print 'The APK SEEMS SAFE'
        print '=================='
